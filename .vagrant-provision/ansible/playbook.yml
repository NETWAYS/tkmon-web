---
- hosts: all
  sudo: true
  roles:
  tasks:
  - name: Ansible alive
    debug: msg="I am alive, let's build TKMON"
  - name: Install packages
    apt: pkg={{item}} state=installed
    with_items:
    - apache2
    - apache2-mpm-event
    - libapache2-mod-fastcgi
    - php5
    - php5-cli
    - php5-sqlite
    - php5-fpm
    - php5-curl
    - php5-xcache
    - php5-xdebug
    - php-pear
    - icinga
    - postfix
    - ntp
  - name: Test PHPUNIT
    stat: path=/usr/local/bin/phpunit
    register: sp
  - name: Download phpunit
    command: 'wget
              https://phar.phpunit.de/phpunit.phar
              -O /usr/local/bin/phpunit.phar'
    when: sp.stat.md5 is not defined
  - name: Rename PHPUNIT
    command: 'mv /usr/local/bin/phpunit.phar /usr/local/bin/phpunit'
    when: sp.stat.md5 is not defined
  - name: chmod PHPUNIT
    command: 'chmod 0755 /usr/local/bin/phpunit'
    when: sp.stat.md5 is not defined
  - name: Configure XCache
    copy: 'src=files/php5/xcache.ini
          dest=/etc/php5/mods-available/xcache.ini
          mode=0644'
  - name: Configure sp.php5-fpm
    copy: 'src=files/php5-fpm/www.conf
          dest=/etc/php5/fpm/pool.d/www.conf
          backup=yes
          mode=0644'
  - name: Restart php5-fpm
    command: /sbin/restart php5-fpm
  - name: Enable apache2 module rewrite
    apache2_module: name=rewrite state=present
  - name: Enable apache2 moduls
    apache2_module: name={{item}} state=present
    with_items:
    - rewrite
    - fastcgi
    - actions
  - name : FastCGI jail
    file: 'path=/var/www/cgi-bin/
          mode=0755
          owner=www-data
          group=www-data
          state=directory'
  - name: Configure apache2
    copy: 'src=files/apache2/fastcgi.conf
          dest=/etc/apache2/mods-available/fastcgi.conf
          backup=yes
          mode=0644'
  - name: TKMON apache2 configuration 1
    copy: 'src=../../etc/apache2/conf.d/tkmon.conf
          dest=/etc/apache2/conf-available/tkmon.conf
          mode=0644'
  - name: TKMON apache2 configuration 2
    command: /usr/sbin/a2enconf tkmon
  - name: Icinga htpass file
    copy: 'src=files/icinga/htpasswd.users
          dest=/etc/icinga/htpasswd.users
          owner=www-data
          group=www-data
          mode=0640'
  - name: TKMON group
    group: name=tkmonweb state=present system=yes
  - name: Copy sudoers
    copy: 'src=../../etc/sudoers.d/tkmon
          dest=/etc/sudoers.d/tkmon
          mode=0440'
  - name: WWW User granted tkmon rights
    user: name=www-data groups=tkmonweb append=yes
  - name: Restart apache2
    service: name=apache2 state=restarted
  - name: Icinga configuration 1
    copy: 'src=files/icinga/icinga.cfg
          dest=/etc/icinga/icinga.cfg
          mode=0644'
  - name: Icinga configuration 2
    copy: 'src=../../etc/icinga/
          dest=/etc/icinga/tkmon'
  - name: Config owner
    command: chown -R 33.33 /etc/icinga/tkmon
  - name: Restart icinga
    service: name=icinga state=restarted